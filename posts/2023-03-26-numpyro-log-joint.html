<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.306">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-03-26">

<title>cached-blog - Translating a Model into a Log Joint Probability</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">cached-blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Translating a Model into a Log Joint Probability</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">probability</div>
                <div class="quarto-category">inference</div>
                <div class="quarto-category">jax</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">March 26, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<section id="objective" class="level2">
<h2 class="anchored" data-anchor-id="objective">Objective</h2>
<p>In probabilistic programming languages (PPLs), one needs to compute the joint probability (often unnormalized) of values and observed variables under a generative model to perform approximate inference. However, given a model in the form of a Python function, how does one translate this function (model) into a log joint probability? The objective of this blog is to better understand how modern PPLs, in particular NumPyro, performs this translation in a dynamic way, i.e., the functions for performing this translation can handle a variety of models defined by the user.</p>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">The Model</h2>
<p>The example <code>zero_inflated_poisson.py</code> from the NumPyro <a href="https://num.pyro.ai/en/stable/examples/zero_inflated_poisson.html">docs</a> will be used. In this example, the authors model and predict how many fish are caught by visitors in a state park. Many groups of visitors catch zero fish, either because they did not fish at all or because they were unlucky. They explicitly model this bimodal behavior (zero versus non-zero) and ascertain which variables contribute to each behavior. The authors answer this question by fitting a zero-inflated poisson regression model. We will use NUTs as the inference method to understand the model translation.</p>
<section id="workflow" class="level3">
<h3 class="anchored" data-anchor-id="workflow">Workflow</h3>
<ol type="1">
<li>Define model using NumPyro primitives</li>
<li>Construct a kernel for inference and feed model into kernel</li>
<li>Perform inference using MCMC</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.numpy <span class="im">as</span> jnp</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> jax.random <span class="im">import</span> PRNGKey</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> jax.scipy <span class="im">as</span> jsp</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpyro.distributions <span class="im">as</span> dist</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer <span class="im">import</span> MCMC, NUTS, SVI, Predictive, Trace_ELBO, autoguide</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpyro.infer <span class="im">import</span> util</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>matplotlib.use(<span class="st">"Agg"</span>)  <span class="co"># noqa: E402</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="14">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> set_seed(seed):</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    random.seed(seed)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    np.random.seed(seed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> model(X, Y):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    D_X <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    b1 <span class="op">=</span> numpyro.sample(<span class="st">"b1"</span>, dist.Normal(<span class="fl">0.0</span>, <span class="fl">1.0</span>).expand([D_X]).to_event(<span class="dv">1</span>))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    b2 <span class="op">=</span> numpyro.sample(<span class="st">"b2"</span>, dist.Normal(<span class="fl">0.0</span>, <span class="fl">1.0</span>).expand([D_X]).to_event(<span class="dv">1</span>))</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    q <span class="op">=</span> jsp.special.expit(jnp.dot(X, b1[:, <span class="va">None</span>])).reshape(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    lam <span class="op">=</span> jnp.exp(jnp.dot(X, b2[:, <span class="va">None</span>]).reshape(<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> numpyro.plate(<span class="st">"obs"</span>, X.shape[<span class="dv">0</span>]):</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        numpyro.sample(<span class="st">"Y"</span>, dist.ZeroInflatedPoisson(gate<span class="op">=</span>q, rate<span class="op">=</span>lam), obs<span class="op">=</span>Y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run_mcmc(model, args, X, Y):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    kernel <span class="op">=</span> NUTS(model)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    mcmc <span class="op">=</span> MCMC(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>        kernel,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>        num_warmup<span class="op">=</span>args.num_warmup,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>        num_samples<span class="op">=</span>args.num_samples,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        num_chains<span class="op">=</span>args.num_chains,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>        progress_bar<span class="op">=</span><span class="va">False</span> <span class="cf">if</span> <span class="st">"NUMPYRO_SPHINXBUILD"</span> <span class="kw">in</span> os.environ <span class="cf">else</span> <span class="va">True</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    mcmc.run(PRNGKey(<span class="dv">1</span>), X, Y)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    mcmc.print_summary()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mcmc.get_samples()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="15">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> main(args):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    set_seed(args.seed)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># prepare dataset</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_stata(<span class="st">"http://www.stata-press.com/data/r11/fish.dta"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">"intercept"</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    cols <span class="op">=</span> [<span class="st">"livebait"</span>, <span class="st">"camper"</span>, <span class="st">"persons"</span>, <span class="st">"child"</span>, <span class="st">"intercept"</span>]</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    mask <span class="op">=</span> np.random.randn(<span class="bu">len</span>(df)) <span class="op">&lt;</span> args.train_size</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    df_train <span class="op">=</span> df[mask]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    df_test <span class="op">=</span> df[<span class="op">~</span>mask]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    X_train <span class="op">=</span> jnp.asarray(df_train[cols].values)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    y_train <span class="op">=</span> jnp.asarray(df_train[<span class="st">"count"</span>].values)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    X_test <span class="op">=</span> jnp.asarray(df_test[cols].values)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    y_test <span class="op">=</span> jnp.asarray(df_test[<span class="st">"count"</span>].values)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"run MCMC."</span>)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    posterior_samples <span class="op">=</span> run_mcmc(model, args, X_train, y_train)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    predictive <span class="op">=</span> Predictive(model, posterior_samples<span class="op">=</span>posterior_samples)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> predictive(PRNGKey(<span class="dv">1</span>), X<span class="op">=</span>X_test, Y<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    mcmc_predictions <span class="op">=</span> jnp.rint(predictions[<span class="st">"Y"</span>].mean(<span class="dv">0</span>))</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"MCMC RMSE: "</span>,</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        mean_squared_error(np.asarray(y_test), np.asarray(mcmc_predictions), squared<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>parser <span class="op">=</span> argparse.ArgumentParser(<span class="st">"Zero-Inflated Poisson Regression"</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--seed"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="dv">42</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"-n"</span>, <span class="st">"--num-samples"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="dv">2000</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--num-warmup"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="dv">1000</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--num-chains"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="dv">1</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--num-data"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="dv">100</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--maxiter"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="dv">5000</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">int</span>)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--train-size"</span>, nargs<span class="op">=</span><span class="st">"?"</span>, default<span class="op">=</span><span class="fl">0.8</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">float</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>parser.add_argument(<span class="st">"--device"</span>, default<span class="op">=</span><span class="st">"cpu"</span>, <span class="bu">type</span><span class="op">=</span><span class="bu">str</span>, <span class="bu">help</span><span class="op">=</span><span class="st">'use "cpu" or "gpu".'</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>args <span class="op">=</span> parser.parse_args(<span class="st">""</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>numpyro.set_platform(args.device)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>numpyro.set_host_device_count(args.num_chains)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>main(args)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="initializing-the-kernel" class="level2">
<h2 class="anchored" data-anchor-id="initializing-the-kernel">Initializing the kernel</h2>
<p>First, we initialize the NUTS kernel with the model. The word <em>kernel</em> is used in a wide range of fields ranging from probabilistic programming, statistics, and deep learning. In PPLs, the name kernel is typically used to define the interface with the sampling algorithm. In this case, we have initialized a NUTS kernel with our model, and this kernel will allow us to interface our model with the underlying HMC sampling variant NUTS.</p>
<p>But, the sampling algorithm can’t simply interface with a Python function. Our model, in the form of a Python function, needs to be translated into a joint log density function and used as input into the sampler. Here, this is where NumPyro performs a series of steps to perform this translation.</p>
<p>When we “feed” the model into the <code>NUTS</code> class an <code>initialize_model</code> utility function is called. This function calls various helper functions such as <code>get_potential_fn</code> and <code>find_valid_initial_params</code> to return a tuple of (<code>init_params_info</code>, <code>potential_fn</code>, <code>postprocess_fn</code>, <code>model_trace</code>). Here, we are interested in <code>initialize_model</code> and <code>get_potential_fn</code>.</p>
<p>The graph of function calls looks like: initialize model <span class="math inline">\(\leftrightarrow\)</span> get potential fn <span class="math inline">\(\leftrightarrow\)</span> potential energy <span class="math inline">\(\leftrightarrow\)</span> log density where each function being called is also returning an object. Below, the sequential order of functions calls are described.</p>
</section>
<section id="initialize_model" class="level2">
<h2 class="anchored" data-anchor-id="initialize_model">initialize_model</h2>
<p><code>initialize_model</code> is a function that returns a tuple of objects and values used as input into the HMC algorithm. At a high level, our model and data are passed into the <code>initialize_model</code> function to intialize the model to some values using the observed data and <code>numpyro.sample</code> statements. This initialization allows us to perform inference with NUTS. Below, the various helper functions that are called within this function are described as these helpers constitute where the majority of our interest lies regarding translating a model into a log joint probability.</p>
</section>
<section id="get_potential_fn" class="level2">
<h2 class="anchored" data-anchor-id="get_potential_fn">get_potential_fn</h2>
<p>Inside of <code>intialize_model</code>, the function <code>get_potential_fn</code> is called. Given a model with Pyro primitives, this Python function returns another function which, given unconstrained parameters, evaluates the potential energy (negative log joint density). In addition, this returns a function to transform unconstrained values at sample sites to constrained values within their respective support.</p>
<p>The interesting parts here are the <em>evaluation of potential energy</em> and the <em>returns a function</em>. First, we focus on the function <code>potential_energy</code> to evaluate the potential energy. Later, we then return to the <code>potential_fn</code> object.</p>
<div class="cell" data-execution_count="7">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_potential_fn(</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    model,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    inv_transforms,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    enum<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    replay_model<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    dynamic_args<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    model_args<span class="op">=</span>(),</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    model_kwargs<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">    (EXPERIMENTAL INTERFACE) Given a model with Pyro primitives, returns a</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">    function which, given unconstrained parameters, evaluates the potential</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">    energy (negative log joint density). In addition, this returns a</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co">    function to transform unconstrained values at sample sites to constrained</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="co">    values within their respective support.</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co">    :param model: Python callable containing Pyro primitives.</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict inv_transforms: dictionary of transforms keyed by names.</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="co">    :param bool enum: whether to enumerate over discrete latent sites.</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co">    :param bool replay_model: whether we need to replay model in</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="co">        `postprocess_fn` to obtain `deterministic` sites.</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="co">    :param bool dynamic_args: if `True`, the `potential_fn` and</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co">        `constraints_fn` are themselves dependent on model arguments.</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="co">        When provided a `*model_args, **model_kwargs`, they return</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="co">        `potential_fn` and `constraints_fn` callables, respectively.</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co">    :param tuple model_args: args provided to the model.</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict model_kwargs: kwargs provided to the model.</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: tuple of (`potential_fn`, `postprocess_fn`). The latter is used</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a><span class="co">        to constrain unconstrained samples (e.g. those returned by HMC)</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co">        to values that lie within the site's support, and return values at</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co">        `deterministic` sites in the model.</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> dynamic_args:</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>        potential_fn <span class="op">=</span> partial(</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>            _partial_args_kwargs, partial(potential_energy, model, enum<span class="op">=</span>enum)</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> replay_model:</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>            <span class="co"># XXX: we seed to sample discrete sites (but not collect them)</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            model_ <span class="op">=</span> seed(model.fn, <span class="dv">0</span>) <span class="cf">if</span> enum <span class="cf">else</span> model</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            postprocess_fn <span class="op">=</span> partial(</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>                _partial_args_kwargs,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>                partial(constrain_fn, model, return_deterministic<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>            postprocess_fn <span class="op">=</span> partial(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>                _drop_args_kwargs, partial(transform_fn, inv_transforms)</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>        model_kwargs <span class="op">=</span> {} <span class="cf">if</span> model_kwargs <span class="kw">is</span> <span class="va">None</span> <span class="cf">else</span> model_kwargs</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>        potential_fn <span class="op">=</span> partial(</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>            potential_energy, model, model_args, model_kwargs, enum<span class="op">=</span>enum</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> replay_model:</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>            model_ <span class="op">=</span> seed(model.fn, <span class="dv">0</span>) <span class="cf">if</span> enum <span class="cf">else</span> model</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>            postprocess_fn <span class="op">=</span> partial(</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>                constrain_fn,</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>                model_,</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>                model_args,</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>                model_kwargs,</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>                return_deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>            postprocess_fn <span class="op">=</span> partial(transform_fn, inv_transforms)</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"potential_fn: </span><span class="sc">{</span>potential_fn<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> potential_fn, postprocess_fn</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="potential_energy" class="level2">
<h2 class="anchored" data-anchor-id="potential_energy">potential_energy</h2>
<p>Computes potential energy (negative joint log density) of a model given unconstrained parameters. Under the hood, NumPyro will transform these unconstrained parameters to the values belonging to the supports of the corresponding priors in the model. To compute the potential energy, this function calls a <code>log_density</code> function that computes the log of joint density for the model given the latent values (parameters).</p>
<div class="cell" data-execution_count="8">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> potential_energy(model, model_args, model_kwargs, params, enum<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">    (EXPERIMENTAL INTERFACE) Computes potential energy of a model given unconstrained params.</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co">    Under the hood, we will transform these unconstrained parameters to the values</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co">    belong to the supports of the corresponding priors in `model`.</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">    :param model: a callable containing NumPyro primitives.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">    :param tuple model_args: args provided to the model.</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict model_kwargs: kwargs provided to the model.</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict params: unconstrained parameters of `model`.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">    :param bool enum: whether to enumerate over discrete latent sites.</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: potential energy given unconstrained parameters.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> enum:</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="im">from</span> numpyro.contrib.funsor <span class="im">import</span> log_density <span class="im">as</span> log_density_</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        log_density_ <span class="op">=</span> log_density</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    substituted_model <span class="op">=</span> substitute(</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        model, substitute_fn<span class="op">=</span>partial(_unconstrain_reparam, params)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># no param is needed for log_density computation because we already substitute</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    log_joint, model_trace <span class="op">=</span> log_density_(</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        substituted_model, model_args, model_kwargs, {}</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"-log_joint: </span><span class="sc">{</span>log_joint<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span>log_joint</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Given our NumPyro model, data (model_args), and initialized parameters (using numpyro.sample), the potential energy (negative log joint density) is the following output:</p>
<pre><code>-log_joint: Traced&lt;ConcreteArray([ 15.773586   15.796449   15.68768    17.106882   16.307858   15.10714
  16.277817   16.401972   17.409088   15.488239   17.44108    20.011204
  15.796449   16.401972   17.409088   15.488239   32.46398    16.306961
  18.321064   15.776845   16.432753   41.972443   16.90719    17.324219
  15.487675   15.68768    15.10714    15.68768    16.96474    61.152782
  16.319      32.46398    56.631355   16.733091   44.390583   15.796449
  31.771408   15.9031725  17.999393   15.929144   15.796449   15.776845
  25.234818   15.487675   32.46398    15.776845   22.136528   16.745249
  15.796449   15.796449   61.152782   17.459694   15.776845   39.30664
  31.771408   17.106882   15.796449   15.776845   16.836826   16.90372
  15.565512   15.266311   15.796449   15.487675   25.503807   66.416145
  42.01054    15.68768    16.438005   35.528217   16.401972  275.8356
  15.488239   46.813717   18.31475    42.01054    15.929144   16.733091
  15.929144   18.632296   16.553946   22.139755   16.879503   16.253452
  15.929144   16.68712    16.90719    17.409088   16.306961   17.900412
  72.883484   20.984446   17.080605   15.68768    15.266311   17.459694
  15.487675   17.409088  221.04407    15.487675   15.68768    15.68768
  15.903938   17.608683   17.233418   16.945618   17.102604   16.230682
  16.401972   20.437622   16.307858   15.776845   66.416145   22.85551
  17.459694   15.266729   18.263693   16.733091   15.68768    16.69443
  17.767635   16.892221   16.277817   16.699389   15.796449   15.776845
  15.68768    17.459694   18.93738    16.401972   41.471767   15.796449
  82.16476    16.664154   15.68768    17.409088   17.106882   15.488239
  15.266729   17.917303   26.629543   21.383934   18.279554   15.929144
  16.90719    38.06461    16.673416   15.487675   16.253452   15.776845
  16.306961   41.61213    15.9031725  15.488239   19.056816   30.152964
  18.068584   15.796449   15.773586   16.216064   17.080605   16.798647
  16.733091   16.307858   38.06461    15.487675   16.69443    66.416145
  16.733091   39.110504   15.266729   15.796449   16.401972   18.379236
  15.929144   16.276924   15.929144   16.306961  360.43808    15.929144
  20.011204   15.776845   15.796449   15.487675   39.291206   15.68768
  15.488239   30.152964   16.879503   15.929144   16.306961   16.69443
  16.401972   16.553946   15.796449   16.673416   17.080605  379.3062
  16.745249   17.896193   16.90719    15.266729   15.776845   15.776845 ], 
  dtype=float32)</code></pre>
</section>
<section id="log_density" class="level2">
<h2 class="anchored" data-anchor-id="log_density">log_density</h2>
<p>The <code>log_density</code> function first uses the effect handler <code>substitute</code> to return a callable which substitutes all primitive calls in <code>fn</code> with values from <code>data</code> whose key matches the site name. If the site name is not present in <code>data</code>, then there is no side effect. After <code>substitute</code>, another effect handler <code>trace</code> is used to record inputs, distributions, and outputs of <code>numpyro.sample</code> statements in the model, and NumPyro primitive calls, generally speaking.</p>
<div class="cell" data-execution_count="9">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_density(model, model_args, model_kwargs, params):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    (EXPERIMENTAL INTERFACE) Computes log of joint density for the model given</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">    latent values ``params``.</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">    :param model: Python callable containing NumPyro primitives.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">    :param tuple model_args: args provided to the model.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict model_kwargs: kwargs provided to the model.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict params: dictionary of current parameter values keyed by site</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">        name.</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: log of joint density and a corresponding model trace</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> substitute(model, data<span class="op">=</span>params)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    model_trace <span class="op">=</span> trace(model).get_trace(<span class="op">*</span>model_args, <span class="op">**</span>model_kwargs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>The effect handlers allow us to effectively loop through each site in the model trace to compute the joint log probability density. In the for loop, if the site <code>type == sample</code> grab that sites value(s) (the samples from the numpyro.sample statement) and evaluate the log probability of the value(s) for that sites <code>fn</code> (dist.Normal(), dist.MultivariateNormal(), etc.) with <code>site['fn'].log_prob(&lt;some value&gt;)</code> The output snippet below shows the site <code>b1</code> defined in the model and the <code>value</code> sampled using the <code>numpyro.sample</code> statement.</p>
<pre><code>site: {'type': 'sample', 'name': 'b1', 'fn': &lt;numpyro.distributions.distribution.Independent object at 0x13a9ceb20&gt;, 'args': (), 'kwargs': {'rng_key': None, 'sample_shape': ()}, 'value': Traced&lt;ConcreteArray([ 1.2406311  -0.5222316  -1.2795658   1.800642   -0.43796206], dtype=float32)&gt;with&lt;JVPTrace(level=2/0)&gt; with
  primal = Array([ 1.2406311 , -0.5222316 , -1.2795658 ,  1.800642  , -0.43796206],      dtype=float32)
  tangent = Traced&lt;ShapedArray(float32[5])&gt;with&lt;JaxprTrace(level=1/0)&gt; with
    pval = (ShapedArray(float32[5]), None)
    recipe = LambdaBinding(), 'scale': None, 'is_observed': False, 'intermediates': [], 'cond_indep_stack': [], 'infer': {}} 

value: Traced&lt;ConcreteArray([ 1.2406311  -0.5222316  -1.2795658   1.800642   -0.43796206], dtype=float32)&gt;with&lt;JVPTrace(level=2/0)&gt; with
  primal = Array([ 1.2406311 , -0.5222316 , -1.2795658 ,  1.800642  , -0.43796206],      dtype=float32)
  tangent = Traced&lt;ShapedArray(float32[5])&gt;with&lt;JaxprTrace(level=1/0)&gt; with
    pval = (ShapedArray(float32[5]), None)
    recipe = LambdaBinding(), </code></pre>
<p>Subsequently, we can also see the <code>fn</code> of this sample site defined in our model:</p>
<pre><code>site fn: &lt;numpyro.distributions.distribution.Independent object at 0x13a9ceb20&gt;</code></pre>
<p>where the <code>fn</code> is an <code>Independent</code> Normal distribution because we called the <code>.to_event(1)</code> method in our model. Next, the log probability for the sample site value is computed by calling the <code>.log_prob()</code> method. For example, the log probability of the sampled values for site <code>b1</code> is:</p>
<pre><code>log prob.    = Traced&lt;ConcreteArray(-8.036343574523926, dtype=float32)</code></pre>
<p>Subsequently, we sum over the log probability for that site. Lastly, the variable <code>log_joint</code> is created for the log joint probability density, and the current site log probability is added to the log joint probability. After looping through each sample site, the log joint then represents the log joint probability density for the model given the latent values (parameters).</p>
<pre><code>log joint         = Traced&lt;ConcreteArray([ -15.773586   -15.796449   -15.68768    -17.106882   -16.307858
  -15.10714    -16.277817   -16.401972   -17.409088   -15.488239
  -17.44108    -20.011204   -15.796449   -16.401972   -17.409088
  -15.488239   -32.46398    -16.306961   -18.321064   -15.776845
  -16.432753   -41.972443   -16.90719    -17.324219   -15.487675
  -15.68768    -15.10714    -15.68768    -16.96474    -61.152782
  -16.319      -32.46398    -56.631355   -16.733091   -44.390583
  -15.796449   -31.771408   -15.9031725  -17.999393   -15.929144
  -15.796449   -15.776845   -25.234818   -15.487675   -32.46398
  -15.776845   -22.136528   -16.745249   -15.796449   -15.796449
  -61.152782   -17.459694   -15.776845   -39.30664    -31.771408
  -17.106882   -15.796449   -15.776845   -16.836826   -16.90372
  -15.565512   -15.266311   -15.796449   -15.487675   -25.503807
  -66.416145   -42.01054    -15.68768    -16.438005   -35.528217
  -16.401972  -275.8356     -15.488239   -46.813717   -18.31475
  -42.01054    -15.929144   -16.733091   -15.929144   -18.632296
  -16.553946   -22.139755   -16.879503   -16.253452   -15.929144
  -16.68712    -16.90719    -17.409088   -16.306961   -17.900412
  -72.883484   -20.984446   -17.080605   -15.68768    -15.266311
  -17.459694   -15.487675   -17.409088  -221.04407    -15.487675
  -15.68768    -15.68768    -15.903938   -17.608683   -17.233418
  -16.945618   -17.102604   -16.230682   -16.401972   -20.437622
  -16.307858   -15.776845   -66.416145   -22.85551    -17.459694
  -15.266729   -18.263693   -16.733091   -15.68768    -16.69443
  -17.767635   -16.892221   -16.277817   -16.699389   -15.796449
  -15.776845   -15.68768    -17.459694   -18.93738    -16.401972
  -41.471767   -15.796449   -82.16476    -16.664154   -15.68768
  -17.409088   -17.106882   -15.488239   -15.266729   -17.917303
  -26.629543   -21.383934   -18.279554   -15.929144   -16.90719
  -38.06461    -16.673416   -15.487675   -16.253452   -15.776845
  -16.306961   -41.61213    -15.9031725  -15.488239   -19.056816
  -30.152964   -18.068584   -15.796449   -15.773586   -16.216064
  -17.080605   -16.798647   -16.733091   -16.307858   -38.06461
  -15.487675   -16.69443    -66.416145   -16.733091   -39.110504
  -15.266729   -15.796449   -16.401972   -18.379236   -15.929144
  -16.276924   -15.929144   -16.306961  -360.43808    -15.929144
  -20.011204   -15.776845   -15.796449   -15.487675   -39.291206
  -15.68768    -15.488239   -30.152964   -16.879503   -15.929144
  -16.306961   -16.69443    -16.401972   -16.553946   -15.796449
  -16.673416   -17.080605  -379.3062     -16.745249   -17.896193
  -16.90719    -15.266729   -15.776845   -15.776845 ], dtype=float32)</code></pre>
<p>And voila, this output is the log joint probability density (and placing a negative sign in front of this array gives you the potential energy) for the model given the latent values. The values in the output above represent the log joint probability of the initialized latent valus, i.e., no inference has been ran yet.</p>
<div class="cell" data-execution_count="10">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> log_density(model, model_args, model_kwargs, params):</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="co">    (EXPERIMENTAL INTERFACE) Computes log of joint density for the model given</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">    latent values ``params``.</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="co">    :param model: Python callable containing NumPyro primitives.</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="co">    :param tuple model_args: args provided to the model.</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict model_kwargs: kwargs provided to the model.</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">    :param dict params: dictionary of current parameter values keyed by site</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co">        name.</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: log of joint density and a corresponding model trace</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> substitute(model, data<span class="op">=</span>params)</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>    model_trace <span class="op">=</span> trace(model).get_trace(<span class="op">*</span>model_args, <span class="op">**</span>model_kwargs)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>    log_joint <span class="op">=</span> jnp.zeros(())</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"---- inside log_density -----"</span>)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> site <span class="kw">in</span> model_trace.values():</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"site: </span><span class="sc">{</span>site<span class="sc">}</span><span class="ss">"</span>, <span class="st">'</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> site[<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"sample"</span>:</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>            value <span class="op">=</span> site[<span class="st">"value"</span>]</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"value: </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">, </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>            intermediates <span class="op">=</span> site[<span class="st">"intermediates"</span>]</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"intermediates: </span><span class="sc">{</span>intermediates<span class="sc">}</span><span class="ss">, </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>            scale <span class="op">=</span> site[<span class="st">"scale"</span>]</span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"site fn: </span><span class="sc">{</span>site[<span class="st">'fn'</span>]<span class="sc">}</span><span class="ss">, </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> intermediates:</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>                log_prob <span class="op">=</span> site[<span class="st">"fn"</span>].log_prob(value, intermediates)</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>                guide_shape <span class="op">=</span> jnp.shape(value)</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>                model_shape <span class="op">=</span> <span class="bu">tuple</span>(</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>                    site[<span class="st">"fn"</span>].shape()</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>                )  <span class="co"># TensorShape from tfp needs casting to tuple</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>                <span class="cf">try</span>:</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>                    broadcast_shapes(guide_shape, model_shape)</span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                <span class="cf">except</span> <span class="pp">ValueError</span>:</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">raise</span> <span class="pp">ValueError</span>(</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"Model and guide shapes disagree at site: '</span><span class="sc">{}</span><span class="st">': </span><span class="sc">{}</span><span class="st"> vs </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>                            site[<span class="st">"name"</span>], model_shape, guide_shape</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>                        )</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>                log_prob <span class="op">=</span> site[<span class="st">"fn"</span>].log_prob(value)</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (scale <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>) <span class="kw">and</span> (<span class="kw">not</span> is_identically_one(scale)):</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>                log_prob <span class="op">=</span> scale <span class="op">*</span> log_prob</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(f"before sum log prob.    = {log_prob}, \n")</span></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a>            <span class="co"># log_prob = jnp.sum(log_prob)</span></span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(f"after sum log prob.     = {log_prob}, \n")</span></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>            log_joint <span class="op">=</span> log_joint <span class="op">+</span> log_prob</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="ss">f"log joint               = </span><span class="sc">{</span>log_joint<span class="sc">}</span><span class="ss">, </span><span class="ch">\n</span><span class="ss">"</span>)</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> log_joint, model_trace</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="returning-to-get_potential_fn" class="level2">
<h2 class="anchored" data-anchor-id="returning-to-get_potential_fn">Returning to get_potential_fn</h2>
<p>However, <code>log_density</code> and <code>potential_energy</code> compute the log probability of the current latent value, not a <strong>function</strong>. Therefore, we return to the Python function <code>get_potential_fn</code> that returns the log joint probability as a function <code>potential_fn</code>, i.e., a function that will evaluate the potential energy given the model args defined by our <code>model</code>, i.e., <code>X_train</code> and <code>y_train</code> and the latent values using the <code>log_density</code> function described above. The <code>potential_fn</code> is then “fed” into the HMC algorithm to perform inference.</p>
<p>What’s great about <code>get_potential_fn</code> is that the log joint probability density function can be accessed externally given our NumPyro model, and passed into other sampling libraries such as <a href="https://blackjax-devs.github.io/blackjax/examples/howto_use_numpyro.html">Blackjax</a>.</p>
</section>
<section id="summary" class="level1">
<h1>Summary</h1>
<p>To translate a NumPyro model, in the form of a Python function, to a joint probability (function and value) a series of function calls are performed. Namely, initialize model <span class="math inline">\(\leftrightarrow\)</span> get potential fn <span class="math inline">\(\leftrightarrow\)</span> potential energy <span class="math inline">\(\leftrightarrow\)</span> log density.</p>
<ul>
<li><code>log_density</code> computes the log probability of the current latent (parameter) value and observed data</li>
<li><code>potential_energy</code> is <code>-log_density</code></li>
<li><code>get_potential_fn</code> returns the log joint probability as a function <code>potential_fn</code>, i.e., a function that will evaluate the potential energy given the model args defined by our <code>model</code>, i.e., <code>X_train</code> and <code>y_train</code> and the latent values using the <code>log_density</code> function. The <code>potential_fn</code> is then “fed” into the HMC algorithm to perform inference.</li>
</ul>
<p>This process allows users to (1) translate their models in a dynamic manner, and (2) access the log joint probability for external use, such as in Blackjax.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>